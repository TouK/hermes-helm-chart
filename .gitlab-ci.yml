stages:
  - build
  - publish
  - deploy
  - clean

default:
  image: docker-gitlab.touk.pl/carpinion/ci/k8s-tools
  before_script:
    - export VERSION=`helm show chart hermes | grep ^version | sed -e "s/.*:\ //;s/SNAPSHOT/SNAPSHOT.${CI_PIPELINE_IID}/"`

build:
  stage: build
  artifacts:
    expire_in: 1d
    paths:
      - ./dist/
  script:
    - helm repo add stable https://kubernetes-charts.storage.googleapis.com/
    - helm repo add incubator https://kubernetes-charts-incubator.storage.googleapis.com/
    - helm dependencies build hermes
    - helm package hermes -d dist --version $VERSION

publish:
  only:
    - tags
  stage: publish
  script:
    - curl -u publisher:MzQwMjY0NTk4ZDc0 --fail --data-binary "@dist/hermes-$VERSION.tgz" https://chartmuseum.carpinion.touk.pl/public/api/charts

deploy:
  stage: deploy
  except:
    - tags
  environment:
    name: $CI_COMMIT_REF_NAME
  script:
    - helm upgrade -i --devel "$CI_ENVIRONMENT_SLUG" ./dist/hermes-$VERSION.tgz -f values.yaml --version $VERSION

clean:
  stage: clean 
  except:
    - master
    - tags
  when: delayed
  start_in: 15 minutes
  allow_failure: true
  environment:
    name: $CI_COMMIT_REF_NAME
  script:
    - helm uninstall "$CI_ENVIRONMENT_SLUG"
